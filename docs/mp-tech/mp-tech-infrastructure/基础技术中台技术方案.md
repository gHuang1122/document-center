# 1.设计依据
基础技术中台基于Docker、Kubernetes作为应用编排框架。集成自研Web控制台、应用实例组控制等运维功能，在开源组件GitLab、Jenkins、Prometheus等基础上二次开发，优化逻辑，实现了应用管理、构建发布等平台级需求。并引入了监控报警等应用保障能力，丰富平台功能，为服务提供了完整的生命周期管理。


基础技术中台建设目标简单可以归纳为如下几点：

1. 通过 DevOps 平台统一管理所有服务，能够提供统一大盘观看服务使用情况；
1. 实现所有应用的持续集成、100% 自动化部署，提升应用的软件交付效率；
1. 保障应用的持续正常运行，提升3倍以上的服务器资源利用率，并提升整体研发、测试、运维效率。



## 2.技术特点
基础技术中台主要的特点是能够关联应用开发中的各个环节，打造应用开发、代码提交、代码审查、编译、构建、配置、发布、监控、告警的整体闭环。结合开源组件提供的各种能力，对应用开发者提供一站式服务，从而实现敏捷开发，高效迭代的目的；

打造一套完整的基础技术中台还有以下优势：

（1）保证一致的运行环境；

（2）弹性伸缩，快速扩容；

（3）方便迁移；

（4）持续集成、持续交付与持续部署。


# 3.系统组成
### 3.1 组成
基础技术中台建设的基本思路，就是要保障各个子模块（容器云平台、 DevOps平台、 微服务治理）能够独立地开展建设，每个子模块内部又可以拆分成一些小的功能模块，然后对每个小的功能模块进行设计开发。例如微服务治理的服务路由要能支持不同的路由规则，路由规则可以基于域名、接口、参数等多种类型进行定制化配置，在保障服务分发功能正常的情况下，建立一套标准的服务路由流程体系，流程体系能够涵盖不同的业务场景，并支持快速配置生效。

​	中台整体技术架构如下图所示：

总体技术架构主要包含容器云、DevOps、微服务治理，基础IT提供基本软硬件环境。

(1)	微服务治理：

微服务治理，解决服务发现、调用等问题。降低各系统间的高度耦合，使系统更易于维护和水平扩展，可以通过流控、隔离、降级等手段保障系统的可用性。

(2)	DevOps：

在底层容器云的基础上，提供了开发所需的各种平台、工具。保障整个开发、构建、发布顺利执行。

(3)	容器云：

该模块主要提供应用编排的能力，让应用容器实例通过一系列算法调度到合适的服务节点上，从而提升整体的资源利用率。  


### 3.2 功能及技术指标

- 本系统的功能有：

（1）应用开发流程与工具：通过对业务开发流程的抽象，制定统一标准的应用开发流程规范，并提供配套的开发工具；

（2）业务配置：基于可视化的方式配置业务使用的各种参数，提供简单、易用、可扩展的SDK方便业务接入；

（3）应用发布：提供包括应用编译、构建、发布一整套流程的上线服务，便于应用开发完成后进行发布测试、发布上线；

（4）服务监控：基于无嵌入的方式，收集应用健康状态的数据，提供应用全生命周期的监控告警服务，支持耗时、日志类型、请求量、接口状态等多种类型的监控策略配置；

（5）服务治理：提供包括服务发现、服务路由、负载均衡、熔断降级、调用链追踪等一整套的服务治理解决方案；

（6）服务运维：提供服务资源调度、多集群管理、实例可视化管理、日志排查等服务运维解决方案；


- 技术指标：

（1）应用开发流程与工具：本流程至少包含代码分支管理、代码提交工具、代码审查规范等核心能力；

（2）业务配置：业务配置支持版本管理、多业务间相互不影响、DB资源配置可复用、配置获取服务高可用；

（3）应用发布：支持页面可视化操作，实现一键编译、构建、打包发布，同时也能单个步骤自定义执行，应用类型至少支持5种（Java、Python、Go、Lua、PHP）；

（4）服务监控：要求对业务代码无嵌入，监控数据类型至少支持4种（包括耗时、日志类型、服务请求量、服务接口状态），告警策略至少支持5种（包括阈值、区间范围、同比、环比、状态码），并且数据类型及告警策略可以比较方便扩展；

（5）服务治理：服务治理方案有配套的可视化管理后台，支持微服务治理5个核心能力（包括服务发现、服务路由、负载均衡、熔断降级、调用链追踪）

（6）服务运维：支持多粒度管理方式，包括容器资源运维、服务实例组运维、集群运维，同时支持可视化运维管理后台。


### 3.3 方案设计
#### 3.3.1 容器云平台
随着虚拟化技术的发展，很多行业已完成物理机虚拟化的进程。这种虚拟化技术一定程度上降低了运维复杂性，提升了资源的使用率。但是运维人员对应用程序环境的管理成本却没有降低，反而应用程序的不断的升级迭代，对操作系统环境的要求差异越来越大，导致运维成本逐渐增加。

而容器技术正是解决了这种环境不一致的问题：容器可以帮我们把开发环境及应用整个打包带走，打包好的容器可以在任何的环境下运行，这样就可以解决开发与运维环境不一致的问题了，所以容器解决了开发和运维之间的矛盾。容器技术在开发和运维之间搭建了一个桥梁，是实现DevOps的最佳解决方案。

- 技术难点

  容器技术的一切看上去似乎都很美好，但是在实际的落地过程中，会出现很多问题。特别是对于刚开始容器云探索的企业来说，这些问题和难点往往会影响容器云平台的建设进度，甚至是发展方向。

1. 容器网络的选择
1. 持久化存储的实现  
1. 容器IP不固定，应用调用实现方案
1. 容器云实现高可用



- 如何实现  

  容器云平台为了解决上述企业在容器技术落地过程中的几个典型问题问题，采用了如下的实现方式：

- 平台兼容性

  本平台可运行于所有标准x86_64架构服务器上，并兼容物理机、云服务器运行环境。支持RedHat Linux、CentOS、Ubuntu等所有现代Linux操作系统。


- 容器网络

  在容器网络上优先考虑公司整个网络扁平化，互联互通，降低应用改造成本，基原始网络打通容器到物理机的网络通信。如果容器的应用是一个相对独立的服务，可以考虑overlay。规模不大的情况下一些开源网络组件可以考虑采用。

  本平台容器网络支持Calico、Flannel的Overlay方案以及公有云厂商所提供的VPC方案；  


- 持久化存储

  首先尽量保证应用的无状态化，避免在应用启动过程中依赖上次的状态。可以将状态信息存放至数据库或者缓存服务中。

  容器云平台支持各种分布式文件系统的对接，例如：Cepth、GlusterFS、NFS等，解决应用持久化的问题。


- 服务间调用

	在传统模式下，应用间通过IP + PORT的模式进行服务间的相互调用，在容器模式下由于IP不固定的特性，无法通过该方式进行调用。
	容器云平台提供了DNS服务通过域名解析，将所有调用请求路由到网关节点中，网关服务会实时感知容器云中的服务实例的IP变化，从而将请求反向代理到目标服务容器中。通应用开发者通过域名进行访问，无需知晓服务具体IP信息。
	平台也提供了服务发现的接口，应用开发者可以通过该接口查询到服务当前的IP信息。


- 容器云高可用

	容器云平台提供了监控报警能力，平台会实时获取应用当前状态，并且内置了应用探针，对应用进行周期性的探活，保证应用的正常执行。
集群容错能力方面，容器云提供了多集群的接入能力，可以对不同的集群进行统一管理，灵活调度，从而避免单集群故障。


- 容器构建

  容器的发布离不开容器镜像的构建，通常开发人员需要手动编写Dockerfile来进行应用程序镜像的构建。
  容器云平台提了供容器构建的能力，通过标准化的Dockerfile模板，使应用开发者的学习、使用成本降到最低。
  在标注模式下应用开发者只需使用默认的Dockerfile模板即可完成应用的镜像构建。应用放也可以自行修改以打到定制化的构建目标。


- 实例组管理

  在物理机模式下，通常应用部署在多个服务器实例中。并且需要对这些实例的版本进行统一管控。
  容器云平台的基于该需求，抽象出了应用实例组概念。将应用划分为多个实例组以满足不同场景的需求（如：AB Test、灰度发布、蓝绿部署等等）。


- 容器调度

	容器构建完毕后，使用容器发布功能进行应用程序的发布。应用发布过程中，容器云平台会对当前应用资源池中的服务器节点进行资源空闲程度、标签匹配策略、服务器状态等多个维度评分。最终将应用调度到目前最合适的服务器节点中。
	当服务器资源紧张时候，会自动对当前服务器上的容器进行重新调度，从而满足服务所需的计算资源需求。
	本平台在普通调度策略之上，还提供了对NVIDIA GPU、AMD GPU 容器集群管理调度的支持，进一步提高了对 GPU 等扩展资源进行统一管理和调度的能力。


- 容器状态监控

  容器的运行状态通常是应用开发者以及运维人员关注的重点。在物理机模式下，通常会在服务器中安装特定的agent程序，抓取相关数据。
  容器模式下无法在每个容器内部去安装相关进程。容器平台基于容器维度，提供了各种基础资源（CPU、内存、网络）的使用情况，并绘制成实时曲线图。应用也可以通过暴露指定的端口，以prometheus的metrics格式来主动提供服务内部的各项指标数据。


- 多集群管理

	通常我们把一个区域（比如同一个机房）内的服务器划分到同一个集群中。如果用户有多区域的需求，可以把在其它区域搭建新集群。容器与平台可以统一对这些集群进行管理、调度。
#### 3.3.2 DevOps平台

- 代码仓库

  DevOps平台提供了基于Git的统一的代码仓库，提供多维度、细粒度的权限体系满足用户所需。

- 镜像仓库

  应用通过镜像来交付，镜像作为应用的标准交付文件，必然需要一个仓库服务来进行存储。DevOps平台基于开源组件Nexus3 OSS，向用户提供了功能强大的镜像仓库服务，用来管理这些容器镜像。

1. 镜像存储：提供镜像存储功能，可以自行指定存储目录；
1. 镜像搜索：支持通过镜像名称搜索仓库内的镜像；
1. 镜像代理仓库：代理第三方仓库，对第三方仓库中的镜像进行缓存，避免反复下载以提升镜像下载、构建速度。
1. 权限管理：支持用户、角色、权限管理功能。

- 持续集成

  DevOps平台持续集成能力，用户可以使用持续集成功能不断地将的代码自动合并到主干源码仓库。
  这些'合并'或者'提交'，每一次并入到仓库通常都伴随着执行一系列的自动化任务：代码的编译，单元测试和集成测试的执行，评判代码质量是否下降的静态代码质量分析等等。


- 发布模板

  应用发布时，容器云平台会将应用相关的各种数据（CPU、内存、启动命令等），通过应用发布模板生成出最终K8S可执行的YAML文件。
  为了支持应用的个性化需求，容器云平台提供了对应用发布模板进行增删改等各种管理功能。在发布时用户可以使用不同的模板进行发布。


- Web控制台

  在物理机部署模式下，运维人员可以通过登录到物理机，执行常用命令对应用程序进行运维操作。
  在容器环境下，应用程序会调度到不同的服务器上，运维人员无法通过传统方式进行命令行操作。
  容器云平台提供了方便快捷的方式，允许应用开发者或运维人员通过Web 控制台以命令行模式进入到容器内部，从而进行传统的运维操作。


- 日志查看

  在物理机部署模式下，通常应用程序会将日志打印在操作系统中的指定目录内。
  容器云平台在应用发布时，会自动记录应用的服务器以及环境信息。并提供了直观的Web UI ，允许用户对应用日志进行查询、搜索功能。在日志查看UI中提供了日志文本搜索的能力。

#### 3.3.3 微服务治理
    “服务化”是实现“快”的一个非常重要的手段。把大量通用功能下沉为服务，并对服务不断进行拆分，再根据不同的业务形态，快速组装出前端应用，通过服务组装和聚合的方式实现更快的开发速度，前端也能变得更轻。把服务拆得越细，服务的粒度越小，可组装性就越好。只有这样，我们才能在业务有需求的时候，利用大量的“小服务”快速构建出一个前端业务应用，支持业务的快速试错。
微服务应运而生。随着微服务架构开始变得火热以后，越来越多的系统被拆解成了多个微服务，那么下一个难题就是，如何管理这些微服务。设想一下，如果你的系统由100个微服务构成，要对这100个微服务进行管理，这绝对是一个不小的挑战。有没有更简单高效的方式可以帮助企业做微服务治理？
基础技术中台对于微服务治理提供了以下功能：

- 服务管理

	提供统一Web UI管理整个服务的生命周期，并整合容器平台、DevOps的能力，为用户提供了统一管理后台。


- 服务发现

  分布式系统中，两个服务需要进行RPC交互，主调方如何知道被调方的IP地址和端口呢？在被调方可能随时变更的情况下，这个问题会被进一步复杂化。
  微服务治理配套设施提供了服务发现能力，用户可以通过标准化的接口查询到服务当前的IP地址，也支持使用监听的方式实时感知应用程序IP变化。


- 服务路由

  在服务发现基础上，平台提供了服务路由的能力。基于标准的HTTP协议，将相同域名上的不同URI路由到指定服务上，从而达到对外入口统一的目的


- 负载均衡

  平台支持7层协议的负载均衡，以反向代理方式接受连接请求，然后将请求转发给内部网络上的应用实例，并将结果返回请求连接的客户端。且支持不同的调度算法策略（轮询、随机、最小连接等）。


- 熔断降级

  服务的稳定是公司可持续发展的重要基石，随着业务量的快速发展，一些平时正常运行的服务，会出现各种突发状况，而且在分布式系统中，每个服务本身又存在很多不可控的因素，比如线程池处理缓慢，导致请求超时，资源不足，导致请求被拒绝
  平台提供了统一的熔断限流框架，以保障服务正常运行。框架实时监控接口的健康值，在达到熔断条件时，自动开启熔断，阻止请求执行。


- 调用链追踪

  一个完整的微服务系统包含多个微服务单元，各个微服务子系统存在互相调用的情况，形成一个 调用链。一个客户端请求从发出到被响应 经历了哪些组件、哪些微服务、请求总时长、每个组件所花时长 等信息我们有必要了解和收集，以帮助我们定位性能瓶颈、进行性能调优，因此监控整个微服务架构的调用链十分有必要。
  微服务治理配套设施提供了统一的调用链追踪框架，基于opentracing规范使用javaaent的模式对应用进行调用链追踪，应用方无需修改代码即可拥有调用链追踪的能力。


- 配置管理

  传统的静态配置方式要想修改某个配置只能修改之后重新发布应用，要实现动态性，可以选择使用数据库，通过定时轮询访问数据库来感知配置的变化。轮询频率低感知配置变化的延时就长，轮询频率高，感知配置变化的延时就短，但比较损耗性能，需要在实时性和性能之间做折中。
  微服务治理配套设施中的配置中心服务专门针对这个业务场景，兼顾实时性和一致性来管理动态配置。将敏感配置信息与代码进行解耦，保障私密数据的安全性。
  应用变更对现有系统的影响，降低了应用系统修复完善的成本，同时提升了业务应用变更的成功率，从而提高了整体IT系统的稳定性。


- 分布式事务支持

	平台提供了开源分布式事务中间件Seata，融合了金融行业在分布式事务技术上的积累及丰富的实践经验，以解决开发者们遇到的分布式事务方面的问题。



 