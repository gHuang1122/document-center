# 一、背景
设想下，我们写了一些通过REST API或者Thrift API调用某个服务的代码，为了发起这个请求，你的代码需要知道服务实例的网络地址(IP 地址和端口号）。在传统运行在物理机器上的应用中，某个服务实例的网络地址一般是静态的，比如，代码可以从只会偶尔更新的配置文件中读取网络地址。

然而在现在流行的基于云平台的微服务应用中， 有更多如下图所示的困难问题需要去解决：

![](https://cdn.nlark.com/yuque/0/2020/webp/2215478/1604559178914-8cf146b8-7947-4f1b-ac14-dd8742abb17e.webp#align=left&display=inline&height=1044&margin=%5Bobject%20Object%5D&originHeight=1044&originWidth=1024&size=0&status=done&style=none&width=1024)

服务实例需要动态分配网络地址，而且，一组服务实例可能会因为自动扩展、失败或者升级发生动态变化，因此 客户端代码应该使用更加精细的服务发现机制。

# 二、技术方案
## 2.1 注册中心
### 2.1.1 什么是注册中心
服务注册中心是服务实现服务化管理的核心组件，类似于目录服务的作用，主要用来存储服务信息，譬如提供者 url 串、路由信息等。服务注册中心是微服务架构中最基础的设施之一。

注册中心可以说是微服务架构中的“通讯录”，它记录了服务和服务地址的映射关系。在分布式架构中，服务会注册到这里，当服务需要调用其它服务时，就到这里找到服务的地址，进行调用。

简单理解就是：在没有注册中心时候，服务间调用需要知道被当服务调方的具体地址（写死的 ip:port）。更换部署地址，就不得不修改调用当中指定的地址。而有了注册中心之后，每个服务在调用别人的时候只需要知道服务名称（软编码）就好，地址都会通过注册中心根据服务名称获取到具体的服务地址进行调用。

举个现实生活中的例子，比如说，我们手机中的通讯录的两个使用场景：

当我想给张三打电话时，那我需要在通讯录中按照名字找到张三，然后就可以找到他的手机号拨打电话。—— 服务发现李四办了手机号并把手机号告诉了我，我把李四的号码存进通讯录，后续，我就可以从通讯录找到他。—— 服务注册通讯录 ——？什么角色（服务注册中心）

**总结：服务注册中心的作用就是「服务的注册」和「服务的发现」。**

### 2.1.2 为什么需要注册中心
在分布式系统中，我们不仅仅是需要在注册中心找到服务和服务地址的映射关系这么简单，我们还需要考虑更多更复杂的问题：

- 服务注册后，如何被及时发现
- 服务宕机后，如何及时下线
- 服务如何有效的水平扩展
- 服务发现时，如何进行路由
- 服务异常时，如何进行降级
- 注册中心如何实现自身的高可用

这些问题的解决都依赖于注册中心。简单看，注册中心的功能有点类似于 DNS 服务器或者负载均衡器，而实际上，注册中心作为微服务的基础组件，可能要更加复杂，也需要更多的灵活性和时效性。

注册中心解决了以下问题：

- 服务管理
- 服务之间的自动发现
- 服务的依赖关系管理

### 2.2.3 使用 Zookeeper 作为服务注册中心
在开源领域有很多成熟的组件可以作为服务注册中心，如：Etcd、ZooKeeper、Consul等，这里我们使用ZooKeeper作为注册中心提供商。

ZooKeeper 是一个分布式的，开放源码的分布式应用程序协调服务，是Google的Chubby一个开源的实现，是Hadoop和Hbase的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。

在服务注册发现体系中，zookeeper可以充当一个服务注册表（Service Registry），让多个服务提供者形成一个集群，让服务消费者通过服务注册表获取具体的服务访问地址（ip+端口）去访问具体的服务提供者。如下图所示：

![](https://cdn.nlark.com/yuque/0/2020/webp/2215478/1604560099480-399c6820-115e-4618-b926-246ece8acedb.webp#align=left&display=inline&height=557&margin=%5Bobject%20Object%5D&originHeight=557&originWidth=1200&size=0&status=done&style=none&width=1200)

## 2.2 服务注册流程
ZooKeeper 原生Java客户端使用过于负责，这里我们应用程序使用 Apache Curator 作为 ZooKeeper 客户端工具。

整个服务注册流程如下

- 应用程序启动时，在 ZooKeeper 中创建临时节点 `/service/应用名/实例ID` ，节点中写入当前服务的状态
- 应用程序顺利启动完毕后，设置节点状态为 Running
- 应用程序关闭时，删除临时节点

## 2.3 服务发现
我们利用 Apache Curator 监听指定应用，可以获取当前应用所有实例列表。

RPC通讯时可以使用自定义的负载均衡策略进行RPC调用。