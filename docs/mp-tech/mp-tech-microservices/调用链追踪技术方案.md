# 一、背景
现代微服务系统中，一套复杂的分布式 Web 系统中，客户端的一次请求操作，可能需要经过系统中多个模块、多个中间件、多台机器的相互协作才能完成，并且这一系列调用请求中，有些是串行处理的，有些是并发执行的，那么如何确定客户端的一次操作背后调用了哪些应用、哪些模块，经过了哪些节点，每个模块的调用先后顺序是怎样的，每个模块的性能问题如何？随着业务系统模型的日趋复杂化，分布式系统中急需一套链路追踪（Trace）系统来解决这些痛点。

分布式服务跟踪是整个分布式系统中跟踪一个用户请求的过程，包括数据采集、数据传输、数据存储、数据分析和数据可视化，捕获此类跟踪让我们构建用户交互背后的整个调用链的视图，这是调试和监控微服务的关键工具。

# 二、技术方案
Skywalking 是一个APM系统，即应用性能监控系统，为微服务架构和云原生架构系统设计。它通过探针自动收集所需的指标，并进行分布式追踪。通过这些调用链路以及指标，Skywalking APM会感知应用间关系和服务间关系，并进行相应的指标统计。目前支持链路追踪和监控应用组件如下，基本涵盖主流框架和容器，如国产PRC Dubbo和motan等，国际化的spring boot，spring cloud都支持了

Skywalking做为生产级的调用链监控工具，不仅提供了丰富的监控系统，而且通过字节码拦截形式集成系统，对系统没有任何侵入性；

## 2.1 SkyWalking 架构
![](https://cdn.nlark.com/yuque/0/2020/webp/2215478/1604573763525-7da308f5-6a6a-478a-96c6-8f0032eb1582.webp#align=left&display=inline&height=589&margin=%5Bobject%20Object%5D&originHeight=589&originWidth=1280&size=0&status=done&style=none&width=1280)

SkyWalking采用组件式开发，易于扩展，主要组件作用如下：

**Skywalking Agent：** 采集（调用链数据）和（指标）信息并上报，上报通过HTTP或者gRPC方式发送数据到Skywalking Collector

**Skywalking Collector ：** 链路数据收集器，对agent传过来的`tracing`和`metric`数据进行整合分析通过`Analysis Core`模块处理并落入相关的数据存储中，同时会通过`Query Core`模块进行二次统计和监控告警

**Storage：** Skywalking的存储，支持以`ElasticSearch`、`Mysql`、`TiDB`、`H2`等作为存储介质进行数据存储

**UI：** Web可视化平台，用来展示落地的数据，目前官方采纳了RocketBot作为SkyWalking的主UI

## 2.2 SkyWalking界面

- 仪表盘

![](https://cdn.nlark.com/yuque/0/2020/webp/2215478/1604573777697-2f691614-10d3-425c-921c-9acc2031d724.webp#align=left&display=inline&height=622&margin=%5Bobject%20Object%5D&originHeight=622&originWidth=1280&size=0&status=done&style=none&width=1280)

仪表盘主要包含Service Dashboard和Database Dashboard

Service Dashboard内分别有Global、Service、Endpoint、Instance面板，展示了全局以及服务、端点、实例的详细信息

Database Dashboard内可以展示数据库的响应时间、响应时间分布、吞吐量、SLA、慢SQL等详细信息，便于直观展示数据库状态

![](https://cdn.nlark.com/yuque/0/2020/webp/2215478/1604573777717-15b62c5f-a0d6-407e-98a6-1b546b7faf7a.webp#align=left&display=inline&height=597&margin=%5Bobject%20Object%5D&originHeight=597&originWidth=1280&size=0&status=done&style=none&width=1280)

- 拓扑图

![](https://cdn.nlark.com/yuque/0/2020/webp/2215478/1604573777683-c9039f07-ec2c-433e-ab16-633f54f82e37.webp#align=left&display=inline&height=622&margin=%5Bobject%20Object%5D&originHeight=622&originWidth=1280&size=0&status=done&style=none&width=1280)

SkyWalking能够根据获取的数据自动绘制服务之间的调用关系图，并能识别常见的服务显示在图标上，例如图上的kafka、H2服务

每条连线的颜色反应了服务之间的调用延迟情况，可以非常直观的看到服务与服务之间的调用状态，连线中间的点能点击，可显示两个服务之间链路的平均响应时间、吞吐率以及SLA等信息

- 追踪面板

![](https://cdn.nlark.com/yuque/0/2020/webp/2215478/1604573777719-0923dea7-1ec6-46df-ba77-7ca7804c3c85.webp#align=left&display=inline&height=622&margin=%5Bobject%20Object%5D&originHeight=622&originWidth=1280&size=0&status=done&style=none&width=1280)

能够显示请求的代码内部执行情况，一个完整的请求都经过了哪些服务、执行了哪些代码方法、每个方法的执行时间、执行状态等详细信息，快速定位代码问题

- 告警面板

![](https://cdn.nlark.com/yuque/0/2020/webp/2215478/1604573777708-da83fdc8-516e-4210-9411-86b168c05669.webp#align=left&display=inline&height=622&margin=%5Bobject%20Object%5D&originHeight=622&originWidth=1280&size=0&status=done&style=none&width=1280)
## 2.3 SkyWalking 集成
Skywalking有多种使用方式，目前最流行(也是最强大)的使用方式是基于Java agent的。

Java agent支持的框架、中间件等，可在 `[https://github.com/apache/skywalking/blob/v6.6.0/docs/en/setup/service-agent/java-agent/Supported-list.md](https://github.com/apache/skywalking/blob/v6.6.0/docs/en/setup/service-agent/java-agent/Supported-list.md)` 查看。

- 除Java agent方式外，Skywalking还支持其他语言的agent，详见 `[https://github.com/apache/skywalking/blob/v6.6.0/docs/en/setup/README.md#language-agents-in-service](https://github.com/apache/skywalking/blob/v6.6.0/docs/en/setup/README.md#language-agents-in-service)`
- 此外，Skywalking还支持基于Service Mesh（例如Istio，详见 `[https://github.com/apache/skywalking/blob/v6.6.0/docs/en/setup/README.md#service-mesh](https://github.com/apache/skywalking/blob/v6.6.0/docs/en/setup/README.md#service-mesh)` ）、Proxy（例如Envoy Proxy，详见 `[https://github.com/apache/skywalking/blob/v6.6.0/docs/en/setup/README.md#service-mesh](https://github.com/apache/skywalking/blob/v6.6.0/docs/en/setup/README.md#service-mesh)` ） ，不过这两种使用方式目前还不是特别流行，故此不做赘述，其实也比较简单。
### 2.3.1 配置java agent

- 找到SkyWalking包中的 `agent` 目录，agent目录结构如下

```
+-- agent
    +-- activations
         apm-toolkit-log4j-1.x-activation.jar
         apm-toolkit-log4j-2.x-activation.jar
         apm-toolkit-logback-1.x-activation.jar
         ...
    +-- config
         agent.config  
    +-- plugins
         apm-dubbo-plugin.jar
         apm-feign-default-http-9.x.jar
         apm-httpClient-4.x-plugin.jar
         .....
    skywalking-agent.jar
```

- 将 `agent` 目录拷贝到任意位置

- 配置

```
config/agent.config
```
：

- 将 `agent.service_name` 修改成你的微服务名称；
- 如果Skywalking和微服务部署在不同的服务器，还需修改 `collector.backend_service` 的值，该配置用来指定微服务和Skywalking通信的地址，默认是 `127.0.0.1:11800` ，按需修改即可。
### 2.3.2 启动应用
#### `java -jar` 启动的应用
例如，有一个Spring Boot应用，则修改完 `agent` 目录后：

- 执行如下命令启动：

```
# 注意-javaagent得在-jar之前哦
java -javaagent:/opt/agent/skywalking-agent.jar -jar somr-spring-boot.jar
```

- 如果想在IDE中启动测试，则可参考下图配置，然后启动即可。

  ![](//upload-images.jianshu.io/upload_images/3865516-efe13a8d6d6325d6.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp#align=left&display=inline&height=726&margin=%5Bobject%20Object%5D&originHeight=726&originWidth=1200&status=done&style=none&width=1200)

  

#### 传统Tomcat应用
##### Linux Tomcat 7-9
修改 `tomcat/bin/catalina.sh` 的第一行：

```
CATALINA_OPTS="$CATALINA_OPTS -javaagent:/opt/agent/skywalking-agent.jar"; export CATALINA_OPTS
```
##### Windows Tomcat 7-9
修改 `tomcat/bin/catalina.bat` 的第一行：

```
set "CATALINA_OPTS=-javaagent:/opt/agent/skywalking-agent.jar"
```
### 2.3.3 效果演示
使用Skywalking监控应用后，当应用API被访问时，就会展示类似如下的图表。

**首页：**

![](//upload-images.jianshu.io/upload_images/3865516-72ea0153e7e1e2ce.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp#align=left&display=inline&height=683&margin=%5Bobject%20Object%5D&originHeight=683&originWidth=1200&status=done&style=none&width=1200)

网络拓扑：可以分析请求的网络去向。例如下图，表示请求首先打到了foodie-dev这个微服务，然后又请求了 这个MySQL数据库。

![](//upload-images.jianshu.io/upload_images/3865516-95c893bc438b8dbb.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp#align=left&display=inline&height=470&margin=%5Bobject%20Object%5D&originHeight=470&originWidth=1200&status=done&style=none&width=1200)

追踪：这个导航栏是我们定位问题时最常用的，可以搜索查询的具体细节。定位性能瓶颈出在了哪个阶段。

![](//upload-images.jianshu.io/upload_images/3865516-22cb6ef30ee32295.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp#align=left&display=inline&height=406&margin=%5Bobject%20Object%5D&originHeight=406&originWidth=1200&status=done&style=none&width=1200)

告警：顾名思义。Skywalking可配置告警规则，当超出配置的阈值时，就推送告警信息。

指标对比：可以对任意的指标进行对比。